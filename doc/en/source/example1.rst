*****************************************
Define and trigger a fog function
*****************************************

FogFlow enables serverless edge computing, meaning that developers can define and submit a so-called fog function and then 
the rest will be done by FogFlow automatically, including:
	*  **triggering the submitted fog function when its input data are available**
	*  **deciding how many instances to be created according to its defined granularity**
	*  **deciding where to deploy the created instances**

The following steps show how to define and test a simple 'hello world' function using the web portal provided by FogFlow Task Designer. 


Define a "hello world" fog function 
-----------------------------------------------

create a fog function from the FogFlow editor 
^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^

    .. figure:: figures/fog-function-menu.png
       :width: 100 %

    .. figure:: figures/fog-function-selected.png
       :width: 100 %

    .. figure:: figures/fog-function-configuration.png
       :width: 100 %

select its input based on entity type
^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^

    .. figure:: figures/fog-function-filter.png
       :width: 100 %

define a granularity for the creation of its function instances
^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^

    .. figure:: figures/fog-function-granularity.png
       :width: 100 %


provide the code of your own function
^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    
    .. code-block:: javascript
    
        exports.handler = function(contextEntity, publish, query, subscribe) {
            console.log("enter into the user-defined fog function");
        
            if (contextEntity == null) {
                return;
            }
            if (contextEntity.attributes == null) {
                return;
            }
        
            var updateEntity = {};
            updateEntity.entityId = {
                id: "Stream.result.001",
                type: 'result',
                isPattern: false
            };
            updateEntity.attributes = {};
            updateEntity.attributes.city = {
                type: 'string',
                value: 'Heidelberg'
            };
        
            updateEntity.metadata = {};
            updateEntity.metadata.location = {
                type: 'point',
                value: {
                    'latitude': 33.0,
                    'longitude': -1.0
                }
            };
        
            publish(updateEntity);
            console.log("publish: ", updateEntity);
        
        };


    .. figure:: figures/fog-function-code.png
       :width: 100 %

submit your fog function
^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    
    .. figure:: figures/fog-function-submit.png
       :width: 100 %


Trigger your "hello world" fog function 
--------------------------------------------

The defined "hello world" fog function is triggered only when its required input data are available. 
With the following command, you can create a "temperature" entity to trigger the function. 


    .. figure:: figures/device-registration.png
       :width: 100 %


.. code-block:: console 

    curl -iX POST \
      'http://localhost:8080/ngsi10/updateContext' \
      -H 'Content-Type: application/json' \
      -d '
    {
        "contextElements": [
            {
                "entityId": {
                    "id": "001",
                    "type": "temperature",
                    "isPattern": false
                },
                "attributes": [
                {
                  "name": "temp",
                  "type": "integer",
                  "contextValue": 10
                }
                ],
                "domainMetadata": [
                {
                    "name": "location",
                    "type": "point",
                    "value": {
                        "latitude": 49.406393,
                        "longitude": 8.684208
                    }
                }
                ]
            }
        ],
        "updateAction": "UPDATE"
    }'

You can check whether the fog function is triggered or not in the following way. 

- check the task instance of this fog function


- check the result generated by its running task instance

    .. code-block:: console 
   
        curl -X GET 'http://localhost:8080/ngsi10/entities' 




